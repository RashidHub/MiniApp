<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    button {
      padding: 12px;
      margin: 6px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<h2>–≠—Ç–∞–ø –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h2>

<button onclick="selectStage('cut')">–†–∞—Å–∫—Ä–æ–π</button>
<button onclick="selectStage('sew')">–ü–æ—à–∏–≤</button>
<button onclick="selectStage('pack')">–ù–∞–±–∏–≤–∫–∞</button>

<br><br>

<button onclick="startScan()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>

<div id="status" style="margin-top:20px;font-weight:bold;"></div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();

  let currentStage = null;

  window.selectStage = function(stage) {
    currentStage = stage;
    document.getElementById("status").innerText =
      "–í—ã–±—Ä–∞–Ω —ç—Ç–∞–ø: " + stage;
  };

  window.startScan = function() {
    if (!currentStage) {
      tg.showPopup({
        title: "–û—à–∏–±–∫–∞",
        message: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø",
        buttons: [{ type: "ok" }]
      });
      return;
    }

    tg.openScanQrPopup(
      { text: "–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑–¥–µ–ª–∏—è" },
      async (result) => {
        if (!result) return;

        document.getElementById("status").innerText =
          "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: " + result;

        const response = await fetch(
          "https://production.korda.spb.ru/scan",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              qr_data: result,
              stage: currentStage,
              user: tg.initDataUnsafe?.user?.id || null
            })
          }
        );

        const data = await response.json();

        tg.showPopup({
          title: data.status === "success" ? "OK" : "–û—à–∏–±–∫–∞",
          message: JSON.stringify(data),
          buttons: [{ type: "ok" }]
        });
      }
    );
  };
</script>

</body>
</html>
