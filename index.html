<script>
  const tg = Telegram.WebApp;
  tg.expand();

  let selectedStage = null;

  // Выбор этапа
  function selectStage(btn) {
    document.querySelectorAll('.stage').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedStage = btn.innerText;
    document.getElementById('startBtn').style.display = 'block';
  }

  // Запуск сканирования
  function startScan() {
    if (!selectedStage) {
      alert("Выберите этап!");
      return;
    }

    // Открываем встроенный сканер Telegram
    tg.openScanQrPopup({
      text: "Отсканируйте DataMatrix"
    }, async (result) => {
      if (!result) {
        alert("Сканирование отменено");
        return;
      }

      // Для отладки: точно видим, что считалось
      console.log("Сканировано:", result);

      try {
        // Отправка POST на сервер
        const response = await fetch("https://office.korda.spb.ru/scan", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            code: result,
            stage: selectedStage,
            user: tg.initDataUnsafe?.user?.id || null
          })
        });

        // Получаем JSON
        const data = await response.json();

        if (data.status === "ok") {
          alert(`Изделие ${result} успешно запущено в производство на этапе ${selectedStage}`);
        } else {
          alert("Ошибка записи на сервере");
        }

      } catch (err) {
        console.error(err);
        alert("Не удалось соединиться с сервером. Проверьте сеть и адрес сервера.");
      }
    });
  }
</script>
